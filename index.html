<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√© Power-Up: Curso de Crisma</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Configura√ß√£o de Fontes e Cores para Estilo Duolingo */
        :root {
            --duo-green: #58cc02;
            --duo-dark-green: #40a000;
            --duo-blue: #1cb0f6;
            --duo-dark-blue: #1899d6;
            --duo-yellow: #ffc800;
            --duo-red: #ff4b4b;
            --duo-light-gray: #f7f7f7;
            --duo-dark-gray: #777;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--duo-light-gray);
            /* Espa√ßo para a barra de navega√ß√£o inferior */
            padding-bottom: 80px; 
            overscroll-behavior-y: none;
        }

        /* Classes personalizadas */
        .duo-header { background-color: white; border-bottom: 2px solid #e5e5e5; }
        
        .duo-lesson-card {
            background-color: white;
            border-bottom: 4px solid #ddd;
            transition: transform 0.1s;
        }
        .duo-lesson-card:active { transform: translateY(2px); border-bottom-width: 2px; }

        .duo-start-btn {
            background-color: var(--duo-green);
            border-bottom: 4px solid var(--duo-dark-green);
            transition: all 0.1s;
        }
        .duo-start-btn:active { transform: translateY(2px); border-bottom-width: 0px; margin-top: 4px; }
        
        .duo-option-btn {
            background-color: white;
            border: 2px solid #e5e5e5;
            border-bottom: 4px solid #e5e5e5;
        }
        .duo-option-btn:active { border-bottom-width: 2px; transform: translateY(2px); }
        .duo-selected { border-color: var(--duo-blue) !important; background-color: #ddf4ff !important; color: var(--duo-blue); }
        .duo-correct { background-color: #d7ffb8 !important; border-color: var(--duo-green) !important; color: var(--duo-dark-green); }
        .duo-wrong { background-color: #ffdde0 !important; border-color: var(--duo-red) !important; color: var(--duo-red); }
        
        /* Barra de Navega√ß√£o Inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e5e5;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 50;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #afafaf;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .nav-item.active { color: var(--duo-blue); }
        .nav-item svg { width: 28px; height: 28px; margin-bottom: 2px; }

        /* Anima√ß√µes */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <svg class="animate-spin h-12 w-12 text-duo-green mb-4" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl font-bold text-gray-700">Carregando...</p>
    </div>

    <!-- Modal de Nome (Boas-vindas) -->
    <div id="name-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-sm text-center animate-slide-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Seja bem-vindo!</h2>
            <p class="text-gray-600 mb-6">Como voc√™ gostaria de ser chamado no Ranking?</p>
            <input type="text" id="user-name-input" placeholder="Seu nome aqui" class="w-full border-2 border-gray-300 rounded-xl p-3 text-lg mb-4 focus:border-duo-blue focus:outline-none text-center font-bold">
            <button onclick="window.App.saveUserName()" class="w-full duo-start-btn text-white font-bold py-3 rounded-xl uppercase tracking-wider">Entrar</button>
        </div>
    </div>

    <!-- Cabe√ßalho Superior -->
    <header class="duo-header p-3 sticky top-0 z-20 shadow-sm flex justify-between items-center px-4">
        <div class="flex items-center">
             <span class="font-extrabold text-xl tracking-tight text-duo-green" id="header-title">F√© Power-Up</span>
        </div>
        <div class="flex items-center space-x-2">
            <div class="flex items-center bg-yellow-100 px-3 py-1 rounded-full border border-yellow-400">
                <svg class="w-4 h-4 text-yellow-600 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                <span id="current-score" class="text-yellow-700 font-bold">0</span>
            </div>
            <div id="hearts-display" class="hidden flex items-center text-duo-red font-bold">
                <svg class="w-6 h-6 fill-current mr-1" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="hearts-count">5</span>
            </div>
        </div>
    </header>

    <!-- Conte√∫do Principal -->
    <div id="app" class="flex flex-col flex-grow w-full max-w-2xl mx-auto"></div>

    <!-- Barra de Navega√ß√£o Inferior -->
    <nav class="bottom-nav">
        <button onclick="window.App.navigateTo('map')" class="nav-item active" id="nav-map">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Aulas
        </button>
        <button onclick="window.App.loadLeaderboard()" class="nav-item" id="nav-ranking">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
            Ranking
        </button>
    </nav>

    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // üî¥ COLE SUAS CHAVES DO FIREBASE AQUI üî¥
        // ==========================================
        const appId = 'crisma-2026';
        
        // Substitua pelo seu c√≥digo do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", 
            authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // ==========================================

        let db, auth;
        let unsubscribeUser;

        window.initializeFirebase = async () => {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_API_KEY_AQUI") {
                 alert("ERRO: Voc√™ precisa abrir o c√≥digo e colar suas chaves do Firebase onde est√° indicado!");
                 document.getElementById('loading-screen').innerHTML = "<p class='p-4 text-red-500'>Erro: Chaves do Firebase n√£o configuradas no c√≥digo.</p>";
                 return;
            }

            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.App.init(db, user.uid);
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Erro Login:", err));
                    }
                });
            } catch (error) {
                console.error("Erro Geral:", error);
            }
        };

        // Escuta o progresso pessoal
        window.startProgressListener = function(userId) {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'progress', 'crisma');
            unsubscribeUser = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.App.setUserProgress(docSnap.data());
                } else {
                    window.App.setUserProgress({ score: 0, completedLessons: {}, name: null });
                }
                document.getElementById('loading-screen').classList.add('hidden');
            });
        };

        // Salva progresso e atualiza o Ranking P√∫blico
        window.saveProgress = async (progress) => {
            if (!window.App.userId || !db) return;
            
            // 1. Salva no perfil do usu√°rio
            const userRef = doc(db, 'artifacts', appId, 'users', window.App.userId, 'progress', 'crisma');
            await setDoc(userRef, progress, { merge: true });

            // 2. Salva na tabela p√∫blica de Ranking (apenas Nome e Score)
            if (progress.name) {
                const leaderboardRef = doc(db, 'artifacts', appId, 'leaderboard', window.App.userId);
                await setDoc(leaderboardRef, {
                    name: progress.name,
                    score: progress.score,
                    lastUpdate: new Date()
                });
            }
        };

        // Busca o Top 20 do Ranking
        window.getLeaderboard = async () => {
            const q = query(collection(db, 'artifacts', appId, 'leaderboard'), orderBy("score", "desc"), limit(20));
            const querySnapshot = await getDocs(q);
            const leaders = [];
            querySnapshot.forEach((doc) => {
                leaders.push(doc.data());
            });
            return leaders;
        };

        window.onload = initializeFirebase;
    </script>

    <script type="text/javascript">
        // Helper para gerar placeholders (Aulas 5 a 28)
        const generatePlaceholderQuestions = (lessonId) => {
            return Array.from({ length: 10 }, (_, i) => ({
                q: `Pergunta ${i + 1} sobre o tema da Aula ${lessonId}? (Este conte√∫do precisa ser editado)`,
                a: "Resposta Correta",
                o: ["Op√ß√£o Errada 1", "Op√ß√£o Errada 2", "Op√ß√£o Errada 3"]
            }));
        };

        // --- CONTE√öDO DO CURSO ---
        // AQUI EST√Å A CORRE√á√ÉO DA AULA 3
        const courseData = {
            1: {
                id: 1,
                title: "Ora√ß√£o - Nossa F√© nos Reuniu",
                bible_ref: "Hebreus 11,6-12",
                points: 200,
                content: ["**O que √© Ora√ß√£o?** √â o di√°logo de amor entre Deus e o homem.", "**A Base da F√©.** Sem f√© √© imposs√≠vel agradar a Deus."],
                quiz_questions: [
                    { q: "Qual o tema principal de Hebreus 11,6?", a: "A import√¢ncia da F√©", o: ["A cria√ß√£o do mundo", "A vida dos anjos", "A vinda de Cristo"] },
                    { q: "Como a Igreja define a Ora√ß√£o?", a: "Di√°logo de amor com Deus", o: ["Recitar textos", "Pedir coisas", "Pensar em problemas"] }
                ]
            },
            2: {
                id: 2,
                title: "Quem √© Deus - A Sant√≠ssima Trindade",
                bible_ref: "1 Jo√£o 4,12-16",
                points: 200,
                content: ["**Mist√©rio:** Um s√≥ Deus em tr√™s Pessoas.", "**Pai, Filho, Esp√≠rito Santo.**"],
                quiz_questions: [
                    { q: "Quantas Pessoas existem na Trindade?", a: "Tr√™s", o: ["Uma", "Duas", "Quatro"] },
                    { q: "Qual a verdade central da f√© crist√£?", a: "A Sant√≠ssima Trindade", o: ["A cria√ß√£o", "Maria", "Os anjos"] }
                ]
            },
            // --- AULA 3 CORRIGIDA COM CONTE√öDO REAL ---
            3: {
                id: 3,
                title: "Jesus - Quem √© o Filho de Deus?",
                bible_ref: "Jo√£o 14,8-11",
                points: 200,
                content: [
                    "**Dupla Natureza:** Jesus √© Verdadeiro Deus e Verdadeiro Homem. Ele n√£o √© metade um, metade outro.",
                    "**O Messias:** 'Cristo' significa 'Ungido'. Ele √© quem o povo de Israel esperava.",
                    "**A Revela√ß√£o:** Quem v√™ Jesus, v√™ o Pai. Ele √© a imagem vis√≠vel do Deus invis√≠vel.",
                    "**O Caminho:** Jesus disse: 'Eu sou o Caminho, a Verdade e a Vida'. Ningu√©m vai ao Pai a n√£o ser por Ele."
                ],
                quiz_questions: [
                    { q: "Quais s√£o as duas naturezas de Jesus?", a: "Divina e Humana", o: ["Anjo e Homem", "Esp√≠rito e Carne", "Rei e Servo"] },
                    { q: "O que Jesus respondeu a Filipe (Jo 14,9)?", a: "Quem me v√™, v√™ o Pai", o: ["O Pai est√° longe", "Eu sou apenas um profeta", "N√£o sei quem √© o Pai"] },
                    { q: "O que significa o t√≠tulo 'Cristo'?", a: "Ungido", o: ["Rei", "Salvador", "Mestre"] },
                    { q: "Jesus disse: 'Eu sou o Caminho, a Verdade e a...'", a: "Vida", o: ["Luz", "Porta", "Paz"] },
                    { q: "Onde Jesus nasceu?", a: "Bel√©m", o: ["Nazar√©", "Jerusal√©m", "Roma"] },
                    { q: "Qual a miss√£o principal de Jesus?", a: "Salvar a humanidade e revelar o Pai", o: ["Ser um l√≠der pol√≠tico", "Ficar rico", "Escrever livros"] }
                ]
            },
            // --- AULA 4 EM DIANTE (PLACEHOLDERS) ---
            // Voc√™ precisa editar aqui igual fiz na Aula 3 para as perguntas aparecerem corretamente
            4: { id: 4, title: "Por que Jesus foi Crucificado?", bible_ref: "Lucas 23,33-47", points: 200, content: ["Jesus morreu pelos pecados.", "Foi amor supremo."], quiz_questions: generatePlaceholderQuestions(4) },
            5: { id: 5, title: "Ressurrei√ß√£o de Jesus", bible_ref: "Jo√£o 20,1-10", points: 200, content: ["O T√∫mulo Vazio.", "Ele venceu a morte."], quiz_questions: generatePlaceholderQuestions(5) },
            // ... Gera o restante autom√°tico
            ...Array.from({length: 23}, (_, i) => i + 6).reduce((acc, id) => {
                acc[id] = {
                    id: id,
                    title: `Aula ${id}: Tema em Constru√ß√£o`,
                    bible_ref: "B√≠blia",
                    points: 200,
                    content: ["Conte√∫do em breve..."],
                    quiz_questions: generatePlaceholderQuestions(id)
                };
                return acc;
            }, {})
        };
        
        courseData[13].title = "üèÜ PROVA INTERMEDI√ÅRIA";
        courseData[28].title = "üèÜ PROVA FINAL";

        // --- L√ìGICA DO APLICATIVO ---
        window.App = {
            db: null,
            userId: null,
            userProgress: { score: 0, completedLessons: {}, name: null },
            state: { currentScreen: 'map', hearts: 5, quizData: [], quizIndex: 0, quizScore: 0 },

            init(dbInstance, userId) {
                this.db = dbInstance;
                this.userId = userId;
                this.render();
            },

            setUserProgress(progress) {
                this.userProgress = { ...this.userProgress, ...progress };
                
                // Se n√£o tem nome, abre o modal
                if (!this.userProgress.name) {
                    document.getElementById('name-modal').classList.remove('hidden');
                    document.getElementById('name-modal').classList.add('flex');
                } else {
                    document.getElementById('name-modal').classList.add('hidden');
                }
                
                this.render();
            },

            saveUserName() {
                const nameInput = document.getElementById('user-name-input');
                const name = nameInput.value.trim();
                if (name.length > 2) {
                    this.userProgress.name = name;
                    window.saveProgress(this.userProgress);
                    document.getElementById('name-modal').classList.add('hidden');
                } else {
                    alert("Por favor, digite um nome v√°lido!");
                }
            },

            navigateTo(screen, param = null) {
                this.state.currentScreen = screen;
                this.state.currentParam = param;
                this.render();
            },

            render() {
                const appDiv = document.getElementById('app');
                const headerTitle = document.getElementById('header-title');
                const scoreDisplay = document.getElementById('current-score');
                const heartsDisplay = document.getElementById('hearts-display');
                
                // Atualiza Header
                scoreDisplay.textContent = this.userProgress.score;
                
                // Gerencia abas ativas
                document.getElementById('nav-map').className = `nav-item ${this.state.currentScreen === 'map' ? 'active' : ''}`;
                document.getElementById('nav-ranking').className = `nav-item ${this.state.currentScreen === 'ranking' ? 'active' : ''}`;

                if (this.state.currentScreen === 'map') {
                    headerTitle.textContent = "Trilha da Crisma";
                    heartsDisplay.classList.add('hidden');
                    appDiv.innerHTML = this.renderMap();
                } 
                else if (this.state.currentScreen === 'lesson') {
                    headerTitle.textContent = "Aula";
                    heartsDisplay.classList.add('hidden');
                    appDiv.innerHTML = "";
                    this.renderLessonContent();
                }
                else if (this.state.currentScreen === 'quiz') {
                    headerTitle.textContent = "Quiz";
                    heartsDisplay.classList.remove('hidden');
                    document.getElementById('hearts-count').textContent = this.state.hearts;
                    appDiv.innerHTML = this.renderQuiz();
                }
                else if (this.state.currentScreen === 'result') {
                    headerTitle.textContent = "Resultado";
                    heartsDisplay.classList.add('hidden');
                    appDiv.innerHTML = this.renderResult();
                }
                else if (this.state.currentScreen === 'ranking') {
                    headerTitle.textContent = "Ranking";
                    heartsDisplay.classList.add('hidden');
                    this.renderRankingScreen();
                }
            },

            renderMap() {
                let html = '<div class="flex flex-col items-center p-4 space-y-4 pb-20 w-full">';
                const ids = Object.keys(courseData).map(Number).sort((a,b) => a - b);
                
                ids.forEach(id => {
                    const lesson = courseData[id];
                    const isCompleted = !!this.userProgress.completedLessons[id];
                    const isUnlocked = id === 1 || !!this.userProgress.completedLessons[id - 1];
                    
                    let bgClass = isUnlocked ? (isCompleted ? 'bg-duo-yellow border-yellow-600' : 'bg-duo-green border-duo-dark-green') : 'bg-gray-200 border-gray-300';
                    let icon = isCompleted ? '‚úì' : (id === 13 || id === 28 ? 'üèÜ' : '‚òÖ');
                    let margin = (id % 2 === 0) ? 'ml-16' : 'mr-16';

                    html += `
                        <div class="flex flex-col items-center w-full ${margin} ${isUnlocked ? '' : 'opacity-60 grayscale'}">
                            <button onclick="window.App.startLesson(${id})" ${!isUnlocked ? 'disabled' : ''} 
                                class="w-20 h-20 rounded-full border-b-4 flex items-center justify-center text-3xl text-white font-bold shadow-lg mb-2 transition-transform active:scale-95 ${bgClass}">
                                ${icon}
                            </button>
                            <span class="text-xs font-bold text-gray-500 bg-white px-2 py-1 rounded border">${lesson.title}</span>
                        </div>
                    `;
                });
                return html + '</div>';
            },

            async renderRankingScreen() {
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = `
                    <div class="p-6 flex flex-col items-center w-full animate-slide-up">
                        <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-lg">
                            <span class="text-5xl">üèÜ</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Melhores Alunos</h2>
                        <div id="ranking-list" class="w-full space-y-3 pb-20">
                            <div class="flex justify-center"><svg class="animate-spin h-8 w-8 text-duo-blue" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                        </div>
                    </div>
                `;

                try {
                    const leaders = await window.getLeaderboard();
                    const listDiv = document.getElementById('ranking-list');
                    listDiv.innerHTML = '';
                    
                    if (leaders.length === 0) {
                        listDiv.innerHTML = '<p class="text-center text-gray-500">Ningu√©m pontuou ainda. Seja o primeiro!</p>';
                        return;
                    }

                    leaders.forEach((user, index) => {
                        const isMe = user.name === this.userProgress.name;
                        let medal = '';
                        if (index === 0) medal = 'ü•á';
                        else if (index === 1) medal = 'ü•à';
                        else if (index === 2) medal = 'ü•â';
                        else medal = `<span class="font-bold text-gray-500">#${index + 1}</span>`;

                        listDiv.innerHTML += `
                            <div class="flex items-center justify-between p-4 rounded-xl border-b-4 ${isMe ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-300' : 'bg-white border-gray-100 shadow-sm'}">
                                <div class="flex items-center space-x-4">
                                    <div class="text-xl w-8 text-center">${medal}</div>
                                    <div class="font-bold text-gray-700 ${isMe ? 'text-duo-blue' : ''}">${user.name} ${isMe ? '(Voc√™)' : ''}</div>
                                </div>
                                <div class="font-bold text-yellow-600 bg-yellow-50 px-3 py-1 rounded-lg">${user.score} XP</div>
                            </div>
                        `;
                    });
                } catch (e) {
                    console.error(e);
                    document.getElementById('ranking-list').innerHTML = '<p class="text-red-500 text-center">Erro ao carregar ranking.</p>';
                }
            },

            startLesson(id) {
                if (courseData[id].content.length > 0) {
                    this.navigateTo('lesson', id);
                } else {
                    this.startQuiz(id);
                }
            },

            renderLessonContent() {
                const lesson = courseData[this.state.currentParam];
                const appDiv = document.getElementById('app');
                
                let contentHtml = `<div class="p-6 flex flex-col h-full animate-slide-up pb-24">
                    <h2 class="text-2xl font-bold mb-2">${lesson.title}</h2>
                    <p class="text-sm text-gray-500 font-bold uppercase mb-6">${lesson.bible_ref}</p>
                    <div class="space-y-4">`;
                
                lesson.content.forEach(text => {
                    const fmt = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>');
                    contentHtml += `<div class="bg-white p-4 rounded-xl border-2 border-gray-100 shadow-sm text-lg text-gray-700">${fmt}</div>`;
                });

                contentHtml += `</div>
                    <div class="fixed bottom-20 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent">
                        <button onclick="window.App.startQuiz(${lesson.id})" class="w-full duo-start-btn py-4 rounded-xl text-white font-bold text-lg uppercase shadow-lg">Come√ßar Quiz</button>
                    </div>
                </div>`;
                
                appDiv.innerHTML = contentHtml;
            },

            startQuiz(id) {
                this.state.hearts = 5;
                this.state.quizScore = 0;
                this.state.quizIndex = 0;
                // Mistura perguntas
                const q = [...courseData[id].quiz_questions].sort(() => Math.random() - 0.5).slice(0, 10);
                this.state.quizData = q;
                this.navigateTo('quiz', id);
            },

            renderQuiz() {
                const q = this.state.quizData[this.state.quizIndex];
                const progress = ((this.state.quizIndex) / this.state.quizData.length) * 100;
                
                // Op√ß√µes misturadas
                const opts = [q.a, ...q.o].sort(() => Math.random() - 0.5);
                
                return `
                    <div class="flex flex-col h-full p-4 pb-24 max-w-lg mx-auto w-full">
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
                            <div class="bg-duo-green h-3 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-8">${q.q}</h2>
                        <div class="space-y-3 flex-grow">
                            ${opts.map(opt => `
                                <button onclick="window.App.checkAnswer(this, '${opt.replace(/'/g, "\\'")}', '${q.a.replace(/'/g, "\\'")}')" 
                                    class="duo-option-btn w-full p-4 rounded-xl text-left text-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            checkAnswer(btn, selected, correct) {
                // Desabilita todos
                const allBtns = document.querySelectorAll('.duo-option-btn');
                allBtns.forEach(b => b.disabled = true);

                if (selected === correct) {
                    btn.classList.add('duo-correct');
                    this.state.quizScore++;
                    // Som de acerto (opcional)
                } else {
                    btn.classList.add('duo-wrong');
                    this.state.hearts--;
                    // Mostra qual era a certa
                    allBtns.forEach(b => {
                        if (b.textContent.trim() === correct) b.classList.add('duo-correct');
                    });
                }

                // Footer de Feedback
                const footer = document.createElement('div');
                footer.className = `fixed bottom-0 left-0 right-0 p-4 border-t-2 z-50 animate-slide-up ${selected === correct ? 'bg-[#d7ffb8] border-[#b8f28b]' : 'bg-[#ffdfe0] border-[#ffc1c7]'}`;
                footer.innerHTML = `
                    <div class="max-w-2xl mx-auto flex justify-between items-center">
                        <div>
                            <div class="font-bold text-xl ${selected === correct ? 'text-duo-dark-green' : 'text-duo-red'}">
                                ${selected === correct ? 'Mandou bem!' : 'Resposta incorreta...'}
                            </div>
                        </div>
                        <button onclick="window.App.nextQuestion()" class="px-6 py-3 rounded-xl font-bold text-white uppercase ${selected === correct ? 'bg-duo-green border-b-4 border-duo-dark-green' : 'bg-duo-red border-b-4 border-[#e53e3e]'}">
                            Continuar
                        </button>
                    </div>
                `;
                document.body.appendChild(footer);
            },

            nextQuestion() {
                // Remove footer antigo
                const footer = document.querySelector('.fixed.bottom-0.z-50');
                if (footer) footer.remove();

                if (this.state.hearts <= 0) {
                    this.finishQuiz(false);
                    return;
                }

                this.state.quizIndex++;
                if (this.state.quizIndex >= this.state.quizData.length) {
                    this.finishQuiz(true);
                } else {
                    document.getElementById('app').innerHTML = this.renderQuiz();
                }
            },

            finishQuiz(passed) {
                const lessonId = this.state.currentParam;
                const total = this.state.quizData.length;
                const score = this.state.quizScore;
                const isWin = passed && score >= Math.ceil(total * 0.6);
                
                if (isWin) {
                    if (!this.userProgress.completedLessons[lessonId]) {
                        this.userProgress.score += courseData[lessonId].points;
                        this.userProgress.completedLessons[lessonId] = true;
                    }
                    window.saveProgress(this.userProgress);
                }

                this.navigateTo('result', { isWin, score, total, xp: isWin ? courseData[lessonId].points : 0 });
            },

            renderResult() {
                const { isWin, score, total, xp } = this.state.currentParam;
                return `
                    <div class="flex flex-col items-center justify-center h-full p-6 text-center animate-slide-up pb-24">
                        <div class="text-8xl mb-6">${isWin ? 'üéâ' : 'üíî'}</div>
                        <h2 class="text-3xl font-bold text-duo-dark-green mb-2">${isWin ? 'Li√ß√£o Conclu√≠da!' : 'N√£o desista!'}</h2>
                        <p class="text-gray-500 text-lg mb-8">Voc√™ acertou ${score} de ${total} quest√µes.</p>
                        ${isWin ? `<div class="bg-yellow-100 border-2 border-yellow-400 p-4 rounded-xl mb-8"><p class="text-yellow-700 font-bold text-xs uppercase">Total XP</p><p class="text-yellow-600 font-bold text-2xl">+${xp}</p></div>` : ''}
                        <button onclick="window.App.navigateTo('map')" class="w-full duo-start-btn py-4 rounded-xl text-white font-bold text-lg uppercase shadow-lg">Continuar</button>
                    </div>
                `;
            },
            
            loadLeaderboard() {
                this.navigateTo('ranking');
            }
        };
    </script>
</body>
</html>
